<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro - Morgue</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/camera.css">
    <link rel="stylesheet" href="css/formulario.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="skull-icon">☠</div>
            <h1>MORGUE</h1>
            <p class="subtitle">Sistema de Registro</p>
        </div>

        <!-- Sección de activar cámara -->
        <div class="camera-section" id="cameraSection">
            <button class="btn-activate-camera" id="btnActivateCamera">
                ⚫ ACTIVAR CÁMARA
            </button>
            <p class="camera-instruction">
                Coloque el documento de identidad frente a la cámara.<br>
                El sistema detectará automáticamente el DNI y extraerá los datos.
            </p>
        </div>

        <!-- Modal de cámara -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <button class="btn-close-camera" id="btnCloseCamera">✕ CERRAR</button>
                <div class="camera-frame" id="cameraFrame">
                    <video id="cameraVideo" autoplay playsinline></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                    <div class="camera-guide"></div>
                    <div class="camera-status" id="cameraStatus">
                        ⬤ BUSCANDO DOCUMENTO
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay de procesamiento -->
        <div class="processing-overlay" id="processingOverlay">
            <div class="spinner"></div>
            <p class="processing-text">Extrayendo datos...</p>
        </div>

        <!-- Sección del formulario -->
        <div class="form-section" id="formSection">
            <div class="form-header">
                <h2>☠ DATOS DEL FALLECIDO</h2>
            </div>

            <form id="formularioFallecido">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Primer Apellido</label>
                        <input type="text" id="primerApellido" name="primerApellido" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Segundo Apellido</label>
                        <input type="text" id="segundoApellido" name="segundoApellido" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Prenombres</label>
                        <input type="text" id="prenombres" name="prenombres" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Edad (Calculada)</label>
                        <input type="text" id="edad" name="edad" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Documento</label>
                        <select id="tipoDocumento" name="tipoDocumento" required>
                            <option value="">Seleccione...</option>
                            <option value="DNI">D.N.I.</option>
                            <option value="CARNET_EXTRANJERIA">Carnet de Extranjería</option>
                            <option value="PASAPORTE">Pasaporte</option>
                            <option value="OTRO">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Número de Documento</label>
                        <input type="text" id="numeroDocumento" name="numeroDocumento" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Sexo</label>
                        <select id="sexo" name="sexo" required>
                            <option value="">Seleccione...</option>
                            <option value="MASCULINO">Masculino</option>
                            <option value="FEMENINO">Femenino</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <select id="estadoCivil" name="estadoCivil" required>
                            <option value="">Seleccione...</option>
                            <option value="SOLTERO">Soltero(a)</option>
                            <option value="CASADO">Casado(a)</option>
                            <option value="VIUDO">Viudo(a)</option>
                            <option value="DIVORCIADO">Divorciado(a)</option>
                            <option value="CONVIVIENTE">Conviviente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Grado de Instrucción</label>
                        <select id="gradoInstruccion" name="gradoInstruccion" required>
                            <option value="">Seleccione...</option>
                            <option value="SIN_INSTRUCCION">Sin Instrucción</option>
                            <option value="PRIMARIA_INCOMPLETA">Primaria Incompleta</option>
                            <option value="PRIMARIA_COMPLETA">Primaria Completa</option>
                            <option value="SECUNDARIA_INCOMPLETA">Secundaria Incompleta</option>
                            <option value="SECUNDARIA_COMPLETA">Secundaria Completa</option>
                            <option value="SUPERIOR_TECNICA">Superior Técnica</option>
                            <option value="SUPERIOR_UNIVERSITARIA">Superior Universitaria</option>
                            <option value="POSTGRADO">Postgrado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha y Hora de Ingreso</label>
                        <input type="datetime-local" id="fechaHoraIngreso" name="fechaHoraIngreso" disabled>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-edit" id="btnEdit">✎ EDITAR</button>
                    <button type="submit" class="btn btn-save" id="btnSave">✓ GUARDAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let isEditing = false;

        // Elementos del DOM
        const btnActivateCamera = document.getElementById('btnActivateCamera');
        const btnCloseCamera = document.getElementById('btnCloseCamera');
        const btnEdit = document.getElementById('btnEdit');
        const btnSave = document.getElementById('btnSave');
        const cameraModal = document.getElementById('cameraModal');
        const cameraSection = document.getElementById('cameraSection');
        const formSection = document.getElementById('formSection');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraFrame = document.getElementById('cameraFrame');
        const cameraStatus = document.getElementById('cameraStatus');
        const processingOverlay = document.getElementById('processingOverlay');
        const formularioFallecido = document.getElementById('formularioFallecido');

        // Establecer fecha y hora actual
        function setFechaHoraActual() {
            const ahora = new Date();
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            
            document.getElementById('fechaHoraIngreso').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Calcular edad
        document.getElementById('fechaNacimiento').addEventListener('change', function() {
            const fechaNacimiento = new Date(this.value);
            const hoy = new Date();
            
            let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
            const mes = hoy.getMonth() - fechaNacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                edad--;
            }
            
            document.getElementById('edad').value = edad + ' AÑOS';
        });

        // Activar cámara
        btnActivateCamera.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                cameraVideo.srcObject = stream;
                cameraModal.classList.add('active');
                
                // Aquí se iniciará la detección automática del DNI
                iniciarDeteccion();
            } catch (error) {
                alert('Error al acceder a la cámara: ' + error.message);
            }
        });

        // Cerrar cámara
        btnCloseCamera.addEventListener('click', () => {
            cerrarCamara();
        });

        function cerrarCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraModal.classList.remove('active');
            cameraFrame.classList.remove('detected');
        }

        // Simulación de detección (aquí se integrará el OCR)
        function iniciarDeteccion() {
            // Por ahora solo simula la detección
            // En el siguiente paso integraremos Tesseract.js
            cameraStatus.textContent = '⬤ BUSCANDO DOCUMENTO';
            
            // Simular detección después de 3 segundos (TEMPORAL)
            setTimeout(() => {
                detectarDNI();
            }, 3000);
        }

        // Función que se ejecutará cuando se detecte el DNI
        function detectarDNI() {
            cameraFrame.classList.add('detected');
            cameraStatus.textContent = '⬤ DOCUMENTO DETECTADO';
            cameraStatus.classList.add('detected');
            
            // Capturar imagen y procesar
            setTimeout(() => {
                capturarYProcesar();
            }, 1000);
        }

        // Capturar imagen y procesar con OCR
        async function capturarYProcesar() {
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0);
            
            // Cerrar cámara
            cerrarCamara();
            
            // Mostrar overlay de procesamiento
            processingOverlay.classList.add('active');
            
            // Aquí se procesará con OCR (siguiente paso)
            // Por ahora simularemos datos extraídos
            setTimeout(() => {
                llenarFormularioConDatos({
                    primerApellido: 'GARCÍA',
                    segundoApellido: 'LÓPEZ',
                    prenombres: 'JUAN CARLOS',
                    fechaNacimiento: '1990-05-15',
                    tipoDocumento: 'DNI',
                    numeroDocumento: '12345678',
                    sexo: 'MASCULINO',
                    estadoCivil: 'SOLTERO',
                    gradoInstruccion: 'SECUNDARIA_COMPLETA'
                });
            }, 2000);
        }

        // Llenar formulario con datos extraídos
        function llenarFormularioConDatos(datos) {
            document.getElementById('primerApellido').value = datos.primerApellido;
            document.getElementById('segundoApellido').value = datos.segundoApellido;
            document.getElementById('prenombres').value = datos.prenombres;
            document.getElementById('fechaNacimiento').value = datos.fechaNacimiento;
            document.getElementById('tipoDocumento').value = datos.tipoDocumento;
            document.getElementById('numeroDocumento').value = datos.numeroDocumento;
            document.getElementById('sexo').value = datos.sexo;
            document.getElementById('estadoCivil').value = datos.estadoCivil;
            document.getElementById('gradoInstruccion').value = datos.gradoInstruccion;
            
            // Calcular edad
            document.getElementById('fechaNacimiento').dispatchEvent(new Event('change'));
            
            // Marcar campos como auto-completados
            document.querySelectorAll('.form-group input:not([disabled]), .form-group select').forEach(field => {
                if (field.value) {
                    field.classList.add('auto-filled');
                }
            });
            
            // Deshabilitar campos (modo solo lectura)
            deshabilitarCampos();
            
            // Ocultar procesamiento
            processingOverlay.classList.remove('active');
            
            // Mostrar formulario
            formSection.classList.add('active');
            
            // Scroll al formulario
            formSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Habilitar/deshabilitar campos
        function deshabilitarCampos() {
            document.querySelectorAll('.form-group input:not([disabled]), .form-group select').forEach(field => {
                field.disabled = true;
            });
            btnEdit.disabled = false;
            isEditing = false;
        }

        function habilitarCampos() {
            document.querySelectorAll('.form-group input:not(#edad):not(#fechaHoraIngreso), .form-group select').forEach(field => {
                field.disabled = false;
            });
            isEditing = true;
        }

        // Botón editar
        btnEdit.addEventListener('click', () => {
            habilitarCampos();
            btnEdit.textContent = '✓ TERMINAR EDICIÓN';
            btnEdit.addEventListener('click', function temp() {
                deshabilitarCampos();
                btnEdit.textContent = '✎ EDITAR';
                btnEdit.removeEventListener('click', temp);
            });
        });

        // Envío del formulario
        formularioFallecido.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                primerApellido: document.getElementById('primerApellido').value,
                segundoApellido: document.getElementById('segundoApellido').value,
                prenombres: document.getElementById('prenombres').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                edad: document.getElementById('edad').value,
                tipoDocumento: document.getElementById('tipoDocumento').value,
                numeroDocumento: document.getElementById('numeroDocumento').value,
                sexo: document.getElementById('sexo').value,
                estadoCivil: document.getElementById('estadoCivil').value,
                gradoInstruccion: document.getElementById('gradoInstruccion').value,
                fechaHoraIngreso: document.getElementById('fechaHoraIngreso').value
            };
            
            console.log('Datos guardados:', formData);
            alert('✓ REGISTRO GUARDADO EXITOSAMENTE');
            
            // Aquí enviarías los datos al servidor
        });

        // Inicializar
        window.addEventListener('load', () => {
            setFechaHoraActual();
        });
    </script>
</body>
</html>