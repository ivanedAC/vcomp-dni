<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro - Morgue</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/camera.css">
    <link rel="stylesheet" href="css/formulario.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="skull-icon">‚ò†</div>
            <h1>MORGUE</h1>
            <p class="subtitle">Sistema de Registro</p>
        </div>

        <!-- Secci√≥n de activar c√°mara -->
        <div class="camera-section" id="cameraSection">
            <button class="btn-activate-camera" id="btnActivateCamera">
                ‚ö´ ACTIVAR C√ÅMARA
            </button>
            <p class="camera-instruction">
                Coloque el documento de identidad frente a la c√°mara.<br>
                El sistema detectar√° autom√°ticamente el DNI y extraer√° los datos.
            </p>
        </div>

        <!-- Modal de c√°mara -->
        <div class="camera-modal" id="cameraModal">
            <div class="camera-container">
                <button class="btn-close-camera" id="btnCloseCamera">‚úï CERRAR</button>
                <div class="camera-frame" id="cameraFrame">
                    <video id="cameraVideo" autoplay playsinline></video>
                    <canvas id="detectionCanvas" style="display: none;"></canvas>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    <div class="camera-guide"></div>
                    <div class="camera-status" id="cameraStatus">
                        ‚¨§ BUSCANDO DOCUMENTO
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay de procesamiento -->
        <div class="processing-overlay" id="processingOverlay">
            <div class="spinner"></div>
            <p class="processing-text" id="processingText">Extrayendo datos...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Secci√≥n del formulario -->
        <div class="form-section" id="formSection">
            <div class="form-header">
                <h2>‚ò† DATOS DEL FALLECIDO</h2>
            </div>

            <form id="formularioFallecido">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Primer Apellido</label>
                        <input type="text" id="primerApellido" name="primerApellido" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Segundo Apellido</label>
                        <input type="text" id="segundoApellido" name="segundoApellido" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Prenombres</label>
                        <input type="text" id="prenombres" name="prenombres" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Edad (Calculada)</label>
                        <input type="text" id="edad" name="edad" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Documento</label>
                        <select id="tipoDocumento" name="tipoDocumento" required>
                            <option value="">Seleccione...</option>
                            <option value="DNI">D.N.I.</option>
                            <option value="CARNET_EXTRANJERIA">Carnet de Extranjer√≠a</option>
                            <option value="PASAPORTE">Pasaporte</option>
                            <option value="OTRO">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>N√∫mero de Documento</label>
                        <input type="text" id="numeroDocumento" name="numeroDocumento" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Sexo</label>
                        <select id="sexo" name="sexo" required>
                            <option value="">Seleccione...</option>
                            <option value="MASCULINO">Masculino</option>
                            <option value="FEMENINO">Femenino</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <select id="estadoCivil" name="estadoCivil" required>
                            <option value="">Seleccione...</option>
                            <option value="SOLTERO">Soltero(a)</option>
                            <option value="CASADO">Casado(a)</option>
                            <option value="VIUDO">Viudo(a)</option>
                            <option value="DIVORCIADO">Divorciado(a)</option>
                            <option value="CONVIVIENTE">Conviviente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Grado de Instrucci√≥n</label>
                        <select id="gradoInstruccion" name="gradoInstruccion" required>
                            <option value="">Seleccione...</option>
                            <option value="SIN_INSTRUCCION">Sin Instrucci√≥n</option>
                            <option value="PRIMARIA_INCOMPLETA">Primaria Incompleta</option>
                            <option value="PRIMARIA_COMPLETA">Primaria Completa</option>
                            <option value="SECUNDARIA_INCOMPLETA">Secundaria Incompleta</option>
                            <option value="SECUNDARIA_COMPLETA">Secundaria Completa</option>
                            <option value="SUPERIOR_TECNICA">Superior T√©cnica</option>
                            <option value="SUPERIOR_UNIVERSITARIA">Superior Universitaria</option>
                            <option value="POSTGRADO">Postgrado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha y Hora de Ingreso</label>
                        <input type="datetime-local" id="fechaHoraIngreso" name="fechaHoraIngreso" disabled>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-edit" id="btnEdit">‚úé EDITAR</button>
                    <button type="submit" class="btn btn-save" id="btnSave">‚úì GUARDAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let detectionInterval = null;
        let isDetecting = false;
        let detectionStableFrames = 0;
        const FRAMES_TO_CONFIRM = 3; // Frames consecutivos para confirmar detecci√≥n
        let tesseractWorker = null;

        // Elementos del DOM
        const btnActivateCamera = document.getElementById('btnActivateCamera');
        const btnCloseCamera = document.getElementById('btnCloseCamera');
        const btnEdit = document.getElementById('btnEdit');
        const cameraModal = document.getElementById('cameraModal');
        const cameraSection = document.getElementById('cameraSection');
        const formSection = document.getElementById('formSection');
        const cameraVideo = document.getElementById('cameraVideo');
        const detectionCanvas = document.getElementById('detectionCanvas');
        const captureCanvas = document.getElementById('captureCanvas');
        const cameraFrame = document.getElementById('cameraFrame');
        const cameraStatus = document.getElementById('cameraStatus');
        const processingOverlay = document.getElementById('processingOverlay');
        const processingText = document.getElementById('processingText');
        const progressFill = document.getElementById('progressFill');
        const formularioFallecido = document.getElementById('formularioFallecido');

        // Establecer fecha y hora actual
        function setFechaHoraActual() {
            const ahora = new Date();
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            
            document.getElementById('fechaHoraIngreso').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Calcular edad
        document.getElementById('fechaNacimiento').addEventListener('change', function() {
            const fechaNacimiento = new Date(this.value);
            const hoy = new Date();
            
            let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
            const mes = hoy.getMonth() - fechaNacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                edad--;
            }
            
            document.getElementById('edad').value = edad + ' A√ëOS';
        });

        // Activar c√°mara
        btnActivateCamera.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                cameraVideo.srcObject = stream;
                cameraModal.classList.add('active');
                
                // Esperar a que el video est√© listo
                cameraVideo.onloadedmetadata = () => {
                    // Configurar canvas de detecci√≥n
                    detectionCanvas.width = cameraVideo.videoWidth;
                    detectionCanvas.height = cameraVideo.videoHeight;
                    
                    // Iniciar detecci√≥n
                    iniciarDeteccion();
                };
            } catch (error) {
                alert('Error al acceder a la c√°mara: ' + error.message);
            }
        });

        // Cerrar c√°mara
        btnCloseCamera.addEventListener('click', () => {
            cerrarCamara();
        });

        function cerrarCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            // Limpiar worker de Tesseract
            if (tesseractWorker) {
                tesseractWorker.terminate();
                tesseractWorker = null;
            }
            cameraModal.classList.remove('active');
            cameraFrame.classList.remove('detected');
            isDetecting = false;
            detectionStableFrames = 0;
        }

        // Detectar DNI en el video
        function iniciarDeteccion() {
            isDetecting = true;
            cameraStatus.textContent = '‚¨§ BUSCANDO DOCUMENTO';
            
            // Analizar frames cada 200ms
            detectionInterval = setInterval(() => {
                detectarDocumento();
            }, 1500);
        }

        let intentoDeteccion = 0; // Agregar contador

        async function detectarDocumento() {
            if (!isDetecting) return;
            
            intentoDeteccion++;
            console.log(`\nüéØ Intento de detecci√≥n #${intentoDeteccion}`);

            const ctx = detectionCanvas.getContext('2d');
            ctx.drawImage(cameraVideo, 0, 0, detectionCanvas.width, detectionCanvas.height);
            
            // Convertir canvas a imagen
            const imageData = detectionCanvas.toDataURL('image/png');
            
            // Enviar a Tesseract para verificar si hay texto
            const tieneTextoRelevante = await verificarTextoConTesseract(imageData);
            
            if (tieneTextoRelevante) {
                detectionStableFrames++;
                console.log(`üü¢ Frame estable: ${detectionStableFrames}/${FRAMES_TO_CONFIRM}`);
                
                if (detectionStableFrames >= FRAMES_TO_CONFIRM) {
                    console.log('üéâ DOCUMENTO CONFIRMADO - Procesando...');
                    documentoDetectado();
                } else {
                    cameraStatus.textContent = `‚¨§ DOCUMENTO DETECTADO... ${detectionStableFrames}/${FRAMES_TO_CONFIRM}`;
                    cameraFrame.classList.add('detected');
                    cameraStatus.classList.add('detected');
                }
            } else {
                if (detectionStableFrames > 0) {
                    console.log('üî¥ Se perdi√≥ la detecci√≥n, reiniciando contador');
                }
                detectionStableFrames = 0;
                cameraFrame.classList.remove('detected');
                cameraStatus.classList.remove('detected');
                cameraStatus.textContent = '‚¨§ BUSCANDO DOCUMENTO';
            }
        }


        async function verificarTextoConTesseract(imageData) {
            try {
                // Inicializar worker solo una vez
                if (!tesseractWorker) {
                    console.log('üîß Inicializando Tesseract worker...');
                    tesseractWorker = await Tesseract.createWorker('spa', 1);
                    console.log('‚úÖ Tesseract worker inicializado');
                }
                
                console.log('üì∏ Analizando frame...');
                
                // Reconocer texto SIN par√°metros problem√°ticos
                const { data: { text } } = await tesseractWorker.recognize(imageData);
                
                console.log('üìÑ Texto detectado:', text.substring(0, 200));
                
                // Verificar si el texto contiene elementos t√≠picos de un DNI
                const textoLimpio = text.toUpperCase();
                
                // Buscar patrones de DNI
                const tieneDNI = /\d{8}/.test(textoLimpio);
                const tieneApellidos = /APELLIDO|NOMBRE|DNI|DOCUMENTO/.test(textoLimpio);
                const tieneFecha = /\d{2}[\/\-]\d{2}[\/\-]\d{4}/.test(textoLimpio);
                
                console.log('üîç Patrones encontrados:');
                console.log('   - DNI (8 d√≠gitos):', tieneDNI);
                console.log('   - Palabras clave:', tieneApellidos);
                console.log('   - Fecha:', tieneFecha);
                
                // Si encuentra al menos 2 de estos elementos, es probable que sea un DNI
                const coincidencias = [tieneDNI, tieneApellidos, tieneFecha].filter(Boolean).length;
                
                console.log('‚úÖ Coincidencias:', coincidencias, '/3', coincidencias >= 2 ? '(V√ÅLIDO)' : '(NO V√ÅLIDO)');
                
                return coincidencias >= 2;
                
            } catch (error) {
                console.error('‚ùå Error en verificaci√≥n OCR:', error);
                return false;
            }
        }

        function documentoDetectado() {
            if (!isDetecting) return;
            
            isDetecting = false;
            clearInterval(detectionInterval);
            
            cameraFrame.classList.add('detected');
            cameraStatus.textContent = '‚¨§ DOCUMENTO DETECTADO';
            cameraStatus.classList.add('detected');
            
            // Capturar y procesar despu√©s de 1 segundo
            setTimeout(() => {
                capturarYProcesar();
            }, 1000);
        }

        // Capturar imagen y procesar con OCR
        async function capturarYProcesar() {
            // Capturar frame actual
            const ctx = captureCanvas.getContext('2d');
            captureCanvas.width = cameraVideo.videoWidth;
            captureCanvas.height = cameraVideo.videoHeight;
            ctx.drawImage(cameraVideo, 0, 0);
            
            // Cerrar c√°mara
            cerrarCamara();
            
            // Mostrar overlay de procesamiento
            processingOverlay.classList.add('active');
            processingText.textContent = 'Inicializando OCR...';
            progressFill.style.width = '10%';
            
            // Convertir canvas a imagen
            const imageData = captureCanvas.toDataURL('image/png');
            
            // Procesar con Tesseract
            await procesarConOCR(imageData);
        }

        // Procesar imagen con Tesseract.js
        async function procesarConOCR(imageData) {
            try {
                processingText.textContent = 'Extrayendo texto...';
                progressFill.style.width = '30%';
                
                const worker = await Tesseract.createWorker('spa', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            progressFill.style.width = (30 + progress * 0.6) + '%';
                        }
                    }
                });
                
                const { data: { text } } = await worker.recognize(imageData);
                
                console.log('Texto extra√≠do:', text);
                
                processingText.textContent = 'Analizando datos...';
                progressFill.style.width = '95%';
                
                // Parsear datos del texto extra√≠do
                const datosExtraidos = parsearDatosDNI(text);
                
                progressFill.style.width = '100%';
                
                await worker.terminate();
                
                // Peque√±a pausa para mostrar progreso completo
                setTimeout(() => {
                    llenarFormularioConDatos(datosExtraidos);
                }, 500);
                
            } catch (error) {
                console.error('Error en OCR:', error);
                processingOverlay.classList.remove('active');
                alert('Error al procesar el documento. Por favor, int√©ntelo nuevamente.');
            }
        }

        // Parsear datos del DNI desde el texto extra√≠do
        function parsearDatosDNI(texto) {
            console.log('Parseando texto:', texto);
            
            const datos = {
                primerApellido: '',
                segundoApellido: '',
                prenombres: '',
                fechaNacimiento: '',
                tipoDocumento: 'DNI',
                numeroDocumento: '',
                sexo: '',
                estadoCivil: '',
                gradoInstruccion: ''
            };
            
            // Limpiar texto
            const textoLimpio = texto.toUpperCase().replace(/\n+/g, ' ').replace(/\s+/g, ' ');
            
            // Buscar n√∫mero de DNI (8 d√≠gitos)
            const dniMatch = textoLimpio.match(/\b(\d{8})\b/);
            if (dniMatch) {
                datos.numeroDocumento = dniMatch[1];
            }
            
            // Buscar apellidos y nombres (despu√©s de "APELLIDOS" o "NOMBRES")
            const apellidosMatch = textoLimpio.match(/APELLIDOS?\s*:?\s*([A-Z√Å√â√ç√ì√ö√ë\s]+?)(?:NOMBRES|PRENOMBRES|FECHA)/i);
            if (apellidosMatch) {
                const apellidos = apellidosMatch[1].trim().split(/\s+/);
                datos.primerApellido = apellidos[0] || '';
                datos.segundoApellido = apellidos[1] || '';
            }
            
            const nombresMatch = textoLimpio.match(/(?:NOMBRES|PRENOMBRES)\s*:?\s*([A-Z√Å√â√ç√ì√ö√ë\s]+?)(?:FECHA|NACIMIENTO|SEXO|\d)/i);
            if (nombresMatch) {
                datos.prenombres = nombresMatch[1].trim();
            }
            
            // Buscar fecha de nacimiento (formato DD/MM/YYYY o DD-MM-YYYY)
            const fechaMatch = textoLimpio.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
            if (fechaMatch) {
                const dia = fechaMatch[1].padStart(2, '0');
                const mes = fechaMatch[2].padStart(2, '0');
                const anio = fechaMatch[3];
                datos.fechaNacimiento = `${anio}-${mes}-${dia}`;
            }
            
            // Buscar sexo
            if (textoLimpio.includes('MASCULINO') || textoLimpio.includes('M') || textoLimpio.includes('HOMBRE')) {
                datos.sexo = 'MASCULINO';
            } else if (textoLimpio.includes('FEMENINO') || textoLimpio.includes('F') || textoLimpio.includes('MUJER')) {
                datos.sexo = 'FEMENINO';
            }
            
            // Buscar estado civil
            if (textoLimpio.includes('SOLTERO')) {
                datos.estadoCivil = 'SOLTERO';
            } else if (textoLimpio.includes('CASADO')) {
                datos.estadoCivil = 'CASADO';
            } else if (textoLimpio.includes('VIUDO')) {
                datos.estadoCivil = 'VIUDO';
            } else if (textoLimpio.includes('DIVORCIADO')) {
                datos.estadoCivil = 'DIVORCIADO';
            } else if (textoLimpio.includes('CONVIVIENTE')) {
                datos.estadoCivil = 'CONVIVIENTE';
            }
            
            // Buscar grado de instrucci√≥n
            if (textoLimpio.includes('SIN INSTRUCCION') || textoLimpio.includes('SIN ESTUDIOS')) {
                datos.gradoInstruccion = 'SIN_INSTRUCCION';
            } else if (textoLimpio.includes('PRIMARIA COMPLETA') || textoLimpio.includes('PRIM. COMPLETA')) {
                datos.gradoInstruccion = 'PRIMARIA_COMPLETA';
            } else if (textoLimpio.includes('PRIMARIA') || textoLimpio.includes('PRIM.')) {
                datos.gradoInstruccion = 'PRIMARIA_INCOMPLETA';
            } else if (textoLimpio.includes('SECUNDARIA COMPLETA') || textoLimpio.includes('SEC. COMPLETA')) {
                datos.gradoInstruccion = 'SECUNDARIA_COMPLETA';
            } else if (textoLimpio.includes('SECUNDARIA') || textoLimpio.includes('SEC.')) {
                datos.gradoInstruccion = 'SECUNDARIA_INCOMPLETA';
            } else if (textoLimpio.includes('SUPERIOR') || textoLimpio.includes('UNIVERSITARIA')) {
                datos.gradoInstruccion = 'SUPERIOR_UNIVERSITARIA';
            } else if (textoLimpio.includes('TECNICA') || textoLimpio.includes('T√âCNICA')) {
                datos.gradoInstruccion = 'SUPERIOR_TECNICA';
            } else if (textoLimpio.includes('POSTGRADO') || textoLimpio.includes('MAESTRIA') || textoLimpio.includes('DOCTORADO')) {
                datos.gradoInstruccion = 'POSTGRADO';
            }
            
            return datos;
        }

        // Llenar formulario con datos extra√≠dos
        function llenarFormularioConDatos(datos) {
            // Rellenar campos
            if (datos.primerApellido) document.getElementById('primerApellido').value = datos.primerApellido;
            if (datos.segundoApellido) document.getElementById('segundoApellido').value = datos.segundoApellido;
            if (datos.prenombres) document.getElementById('prenombres').value = datos.prenombres;
            if (datos.fechaNacimiento) {
                document.getElementById('fechaNacimiento').value = datos.fechaNacimiento;
                // Calcular edad
                document.getElementById('fechaNacimiento').dispatchEvent(new Event('change'));
            }
            if (datos.tipoDocumento) document.getElementById('tipoDocumento').value = datos.tipoDocumento;
            if (datos.numeroDocumento) document.getElementById('numeroDocumento').value = datos.numeroDocumento;
            if (datos.sexo) document.getElementById('sexo').value = datos.sexo;
            if (datos.estadoCivil) document.getElementById('estadoCivil').value = datos.estadoCivil;
            if (datos.gradoInstruccion) document.getElementById('gradoInstruccion').value = datos.gradoInstruccion;
            
            // Marcar campos como auto-completados
            document.querySelectorAll('.form-group input:not([disabled]), .form-group select').forEach(field => {
                if (field.value && field.id !== 'tipoDocumento') {
                    field.classList.add('auto-filled');
                }
            });
            
            // Deshabilitar campos (modo solo lectura)
            deshabilitarCampos();
            
            // Ocultar procesamiento
            processingOverlay.classList.remove('active');
            progressFill.style.width = '0%';
            
            // Mostrar formulario
            formSection.classList.add('active');
            
            // Scroll al formulario
            setTimeout(() => {
                formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Habilitar/deshabilitar campos
        function deshabilitarCampos() {
            document.querySelectorAll('.form-group input:not([disabled]), .form-group select').forEach(field => {
                field.disabled = true;
            });
            btnEdit.disabled = false;
        }

        function habilitarCampos() {
            document.querySelectorAll('.form-group input:not(#edad):not(#fechaHoraIngreso), .form-group select').forEach(field => {
                field.disabled = false;
            });
        }

        // Bot√≥n editar
        let editMode = false;
        btnEdit.addEventListener('click', () => {
            if (!editMode) {
                habilitarCampos();
                btnEdit.textContent = '‚úì TERMINAR EDICI√ìN';
                editMode = true;
            } else {
                deshabilitarCampos();
                btnEdit.textContent = '‚úé EDITAR';
                editMode = false;
            }
        });

        // Env√≠o del formulario
        formularioFallecido.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                primerApellido: document.getElementById('primerApellido').value,
                segundoApellido: document.getElementById('segundoApellido').value,
                prenombres: document.getElementById('prenombres').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                edad: document.getElementById('edad').value,
                tipoDocumento: document.getElementById('tipoDocumento').value,
                numeroDocumento: document.getElementById('numeroDocumento').value,
                sexo: document.getElementById('sexo').value,
                estadoCivil: document.getElementById('estadoCivil').value,
                gradoInstruccion: document.getElementById('gradoInstruccion').value,
                fechaHoraIngreso: document.getElementById('fechaHoraIngreso').value
            };
            
            console.log('Datos guardados:', formData);
            alert('‚úì REGISTRO GUARDADO EXITOSAMENTE\n\nPuedes ver los datos en la consola del navegador (F12)');
            
            // Aqu√≠ enviar√≠as los datos al servidor
            // fetch('/api/guardar-registro', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(formData)
            // });
        });

        // Inicializar
        window.addEventListener('load', () => {
            setFechaHoraActual();
        });
    </script>
</body>

</html>